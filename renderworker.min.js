function Complex(a,b){this.Re=a?a:0,this.Im=b?b:0}function ComplexPolynomial(a){this.coeffs=a}Complex.prototype.add=function(a){return new Complex(this.Re+a.Re,this.Im+a.Im)},Complex.prototype.sub=function(a){return new Complex(this.Re-a.Re,this.Im-a.Im)},Complex.prototype.mul=function(a){return new Complex(this.Re*a.Re-this.Im*a.Im,this.Re*a.Im+this.Im*a.Re)},Complex.prototype.scale=function(a){return new Complex(this.Re*a,this.Im*a)},Complex.prototype.div=function(a){var b=1/a.absSquared();return new Complex((this.Re*a.Re+this.Im*a.Im)*b,(this.Im*a.Re-this.Re*a.Im)*b)},Complex.prototype.abs=function(){return Math.sqrt(this.absSquared())},Complex.prototype.absSquared=function(){return this.Re*this.Re+this.Im*this.Im},Complex.prototype.arg=function(){return Math.atan2(this.Im,this.Re)},ComplexPolynomial.fromRoots=function(a){if(a.length<1)return void 0;for(var b=[new Complex(1,0)],c=0,d=a.length;d>c;c++){b.splice(0,0,new Complex(0,0));for(var e=0,f=b.length-1;f>e;e++)b[e]=b[e].add(b[e+1].mul(a[c].scale(-1)))}return new ComplexPolynomial(b)},ComplexPolynomial.prototype.evaluate=function(a){for(var b=new Complex(0,0),c=this.coeffs,d=c.length-1;d>=0;d--)b=b.mul(a).add(c[d]);return b},ComplexPolynomial.prototype.derivative=function(){for(var a=[],b=1,c=this.coeffs.length;c>b;b++)a.push(this.coeffs[b].scale(b));return new ComplexPolynomial(a)};var newton={iterate:function(a,b,c,d,e,f){var g,h=a,i=0;do h=h.sub(b.evaluate(h).div(c.evaluate(h))),g=newton.whichRoot(h,d,e),i++;while(!g&&f>i);return g?i+=Math.log(e/g.previousDistance)/Math.log(g.distance/g.previousDistance):g=d[0],{root:g,iter:i}},whichRoot:function(a,b,c){for(var d=0,e=b.length;e>d;d++)if(b[d].previousDistance=b[d].distance,b[d].distance=a.sub(b[d].root).absSquared(),b[d].distance<c)return b[d]}},renderer={render:function(a,b,c,d){for(var e,f=new ArrayBuffer(4*b*c),g=new Uint8ClampedArray(f),h=(a.reMax-a.reMin)/(b-1),i=(a.imMax-a.imMin)/(c-1),j=ComplexPolynomial.fromRoots(a.roots.map(function(a){return new Complex(a.root.Re,a.root.Im)})),k=j.derivative(),l=[],m=0,n=0,o=a.eps*a.eps,p=0;c>p;p++)for(var q=0;b>q;q++)l.push(newton.iterate(new Complex(a.reMin+q*h,a.imMin+p*i),j,k,a.roots,o,a.maxIter)),d||(n=Math.max(n,l[l.length-1].iter));d&&(n=d);var r=1/n;for(p=0,len=l.length;len>p;p++)e=renderer.HSVtoRGB(l[p].root.hue,1,1-l[p].iter*r),g[m++]=e.R,g[m++]=e.G,g[m++]=e.B,g[m++]=255;return{buffer:f,exposure:n}},HSVtoRGB:function(a,b,c){var d,e=c*b,f=6*a,g=e*(1-Math.abs(f%2-1)),h=c-e;return d=1>f?{R:e,G:g,B:0}:2>f?{R:g,G:e,B:0}:3>f?{R:0,G:e,B:g}:4>f?{R:0,G:g,B:e}:5>f?{R:g,G:0,B:e}:{R:e,G:0,B:g},d.R+=h,d.G+=h,d.B+=h,d.R*=255,d.G*=255,d.B*=255,d}};onmessage=function(a){var b=renderer.render(a.data.config,a.data.width,a.data.height,a.data.exposure);postMessage(b,[b.buffer])};